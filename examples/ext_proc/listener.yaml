# THIS FILE IS GENERATED BY scripts/configmap.ts, PLEASE DO NOT EDIT IT OR YOU WILL BE FIRED.
resources:
  - '@type': type.googleapis.com/envoy.config.listener.v3.Listener
    name: external_http
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 30000
    per_connection_buffer_limit_bytes: 32768
    filter_chains:
      - filters:
          - name: envoy.http_connection_manager
            typed_config:
              '@type': type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              use_remote_address: true
              xff_num_trusted_hops: 0
              normalize_path: true
              merge_slashes: true
              path_with_escaped_slashes_action: UNESCAPE_AND_REDIRECT
              common_http_protocol_options:
                idle_timeout: 3600s
                headers_with_underscores_action: ALLOW
#              http2_protocol_options:
#                max_concurrent_streams: 100
#                initial_stream_window_size: 65536
#                initial_connection_window_size: 1048576
              request_timeout: 600s
              request_headers_timeout: 30s
              always_set_request_id_in_response: true
              strip_any_host_port: true
              http_filters:
                - name: envoy.filters.http.grpc_json_transcoder
                  typed_config:
                    '@type': type.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder
                    proto_descriptor: upstream/gen/moego.bin
                    services:
                      - moego.api.todo.v1.GreetService
                    print_options:
                      add_whitespace: false
                      always_print_primitive_fields: true
                      always_print_enums_as_ints: true
                      preserve_proto_field_names: false
                    auto_mapping: true
                    ignore_unknown_query_parameters: true
                    convert_grpc_status: true
                - name: envoy.filters.http.ext_proc
                  typed_config:
                    '@type': type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                    grpc_service:
                      envoy_grpc:
                        cluster_name: ext-proc
                    processing_mode:
                      request_header_mode: SEND
                      response_header_mode: SKIP
                      request_body_mode: NONE
                      response_body_mode: NONE
                      request_trailer_mode: SKIP
                      response_trailer_mode: SKIP
                - name: envoy.filters.http.dynamic_forward_proxy
                  typed_config:
                    '@type': type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                    dns_cache_config:
                      name: dynamic_forward_proxy_cache_config
                      dns_lookup_family: V4_ONLY
                - name: envoy.filters.http.router
                  typed_config:
                    '@type': type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              route_config:
                name: local_route
                virtual_hosts:
                  - name: '*'
                    domains:
                      - '*'
                    routes:
                      - match:
                          prefix: /
                          headers:
                            - name: Grey-Version-localhost:8080
                              present_match: true
                        route:
                          cluster: dynamic_forward_proxy_cluster
                          timeout: 0s
                        typed_per_filter_config:
                          envoy.filters.http.dynamic_forward_proxy:
                            '@type': type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.PerRouteConfig
                            host_rewrite_header: Grey-Version-localhost:8080
                      - match:
                          prefix: /
                        route:
                          cluster: localhost
                          timeout: 0s
